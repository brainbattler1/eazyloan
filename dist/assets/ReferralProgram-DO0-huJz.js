import{u as I,s as j,j as e}from"./index-DjnEXITF.js";import{r as i}from"./router-MjQpq3_0.js";import"./vendor-CSSWAZE4.js";import"./supabase-mDnqn92m.js";const H=({onClose:N})=>{const{user:h}=I(),[R,u]=i.useState(!0),[l,$]=i.useState({referral_code:"",total_referrals:0,pending_referrals:0,completed_referrals:0,total_rewards:0}),[b,E]=i.useState([]),[g,f]=i.useState(!1),[w,x]=i.useState(null);i.useEffect(()=>{h&&S()},[h]);const S=async()=>{try{const{data:a,error:s}=await j.from("referral_codes").select("count").limit(1);if(s){console.warn("Database connection test failed:",s),x(`Database connection failed: ${s.message}`),u(!1);return}y()}catch(a){console.error("Connection test error:",a),x("Unable to connect to database. Please check your internet connection."),u(!1)}},y=async()=>{var a,s,t,d,k;try{u(!0),x(null);const{data:r,error:n}=await j.rpc("get_user_referral_stats",{check_user_id:h.id});if(n)throw n;r&&r.length>0&&$(r[0]);const{data:m,error:C}=await j.from("referrals").select(`
          id,
          status,
          reward_amount,
          reward_given,
          created_at,
          completed_at,
          referred_id
        `).eq("referrer_id",h.id).order("created_at",{ascending:!1});if(m&&m.length>0){const L=m.map(c=>c.referred_id),{data:v}=await j.from("user_profiles").select("user_id, first_name, last_name, username").in("user_id",L),P=new Map((v==null?void 0:v.map(c=>[c.user_id,c]))||[]);m.forEach(c=>{const T=P.get(c.referred_id);c.user_profiles=T||null})}if(C)throw C;E(m||[])}catch(r){console.error("Error fetching referral data:",r);let n="Failed to load referral data";(a=r.message)!=null&&a.includes("function get_user_referral_stats")?n="Referral system not properly initialized. Please contact support.":(s=r.message)!=null&&s.includes('relation "referral_codes" does not exist')?n="Referral database tables not found. Please run database migrations.":(t=r.message)!=null&&t.includes('relation "user_profiles" does not exist')?n="User profiles table not found. Please run database migrations.":(d=r.message)!=null&&d.includes("JWT")?n="Authentication error. Please log in again.":(k=r.message)!=null&&k.includes("permission denied")?n="Permission denied. Please check your account status.":r.message&&(n=`Error: ${r.message}`),x(n)}finally{u(!1)}},p=()=>{const a=window.location.origin;return l!=null&&l.referral_code?`${a}/?ref=${l.referral_code}`:(console.warn("No referral code available"),`${a}/?ref=`)},_=async()=>{try{await navigator.clipboard.writeText(p()),f(!0),setTimeout(()=>f(!1),2e3)}catch(a){console.error("Failed to copy link:",a);const s=document.createElement("textarea");s.value=p(),document.body.appendChild(s),s.select(),document.execCommand("copy"),document.body.removeChild(s),f(!0),setTimeout(()=>f(!1),2e3)}},o=async a=>{const s=p(),t=`Join me on EazyLoans and get started with your loan application! Use my referral link: ${s}`;switch(a){case"whatsapp":window.open(`https://wa.me/?text=${encodeURIComponent(t)}`,"_blank");break;case"telegram":window.open(`https://t.me/share/url?url=${encodeURIComponent(s)}&text=${encodeURIComponent("Join me on EazyLoans!")}`,"_blank");break;case"twitter":window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(t)}`,"_blank");break;case"facebook":window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(s)}`,"_blank");break;case"email":window.open(`mailto:?subject=${encodeURIComponent("Join EazyLoans!")}&body=${encodeURIComponent(t)}`,"_blank");break;default:_()}},U=a=>{const s={pending:{text:"Pending",class:"status-pending",icon:"â³"},completed:{text:"Completed",class:"status-completed",icon:"âœ…"},cancelled:{text:"Cancelled",class:"status-cancelled",icon:"âŒ"}};return s[a]||s.pending};return R?e.jsxs("div",{className:"referral-program",children:[e.jsxs("div",{className:"referral-header",children:[e.jsx("h2",{children:"ðŸŽ Referral Program"}),e.jsx("button",{onClick:N,className:"close-btn",children:"Ã—"})]}),e.jsxs("div",{className:"loading-container",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:"Loading referral data..."})]})]}):w?e.jsxs("div",{className:"referral-program",children:[e.jsxs("div",{className:"referral-header",children:[e.jsx("h2",{children:"ðŸŽ Referral Program"}),e.jsx("button",{onClick:N,className:"close-btn",children:"Ã—"})]}),e.jsxs("div",{className:"error-container",children:[e.jsx("div",{className:"error-icon",children:"âš ï¸"}),e.jsx("h3",{children:"Error Loading Referral Data"}),e.jsx("p",{children:w}),e.jsx("button",{onClick:y,className:"retry-btn",children:"ðŸ”„ Try Again"})]})]}):e.jsxs("div",{className:"referral-program",children:[e.jsxs("div",{className:"referral-header",children:[e.jsx("h2",{children:"ðŸŽ Referral Program"}),e.jsx("button",{onClick:N,className:"close-btn",children:"Ã—"})]}),e.jsx("div",{className:"referral-stats",children:e.jsxs("div",{className:"stats-grid",children:[e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-icon",children:"ðŸ‘¥"}),e.jsxs("div",{className:"stat-content",children:[e.jsx("div",{className:"stat-number",children:l.total_referrals}),e.jsx("div",{className:"stat-label",children:"Total Referrals"})]})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-icon",children:"â³"}),e.jsxs("div",{className:"stat-content",children:[e.jsx("div",{className:"stat-number",children:l.pending_referrals}),e.jsx("div",{className:"stat-label",children:"Pending"})]})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-icon",children:"âœ…"}),e.jsxs("div",{className:"stat-content",children:[e.jsx("div",{className:"stat-number",children:l.completed_referrals}),e.jsx("div",{className:"stat-label",children:"Completed"})]})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-icon",children:"ðŸ’°"}),e.jsxs("div",{className:"stat-content",children:[e.jsxs("div",{className:"stat-number",children:["$",(l.total_rewards||0).toLocaleString()]}),e.jsx("div",{className:"stat-label",children:"Total Rewards"})]})]})]})}),e.jsxs("div",{className:"referral-link-section",children:[e.jsx("h3",{children:"ðŸ“Ž Your Referral Link"}),e.jsxs("div",{className:"referral-link-container",children:[e.jsxs("div",{className:"referral-code-display",children:[e.jsx("span",{className:"code-label",children:"Your Code:"}),e.jsx("span",{className:"referral-code",children:l.referral_code})]}),e.jsxs("div",{className:"link-input-container",children:[e.jsx("input",{type:"text",value:p(),readOnly:!0,className:"referral-link-input"}),e.jsx("button",{onClick:_,className:`copy-btn ${g?"copied":""}`,children:g?"âœ… Copied!":"ðŸ“‹ Copy"})]})]}),e.jsxs("div",{className:"share-section",children:[e.jsx("h4",{children:"ðŸ“¢ Share Your Link"}),e.jsxs("div",{className:"share-buttons",children:[e.jsx("button",{onClick:()=>o("whatsapp"),className:"share-btn whatsapp",children:"ðŸ“± WhatsApp"}),e.jsx("button",{onClick:()=>o("telegram"),className:"share-btn telegram",children:"âœˆï¸ Telegram"}),e.jsx("button",{onClick:()=>o("twitter"),className:"share-btn twitter",children:"ðŸ¦ Twitter"}),e.jsx("button",{onClick:()=>o("facebook"),className:"share-btn facebook",children:"ðŸ“˜ Facebook"}),e.jsx("button",{onClick:()=>o("email"),className:"share-btn email",children:"ðŸ“§ Email"})]})]})]}),e.jsxs("div",{className:"how-it-works",children:[e.jsx("h3",{children:"ðŸŽ¯ How It Works"}),e.jsxs("div",{className:"steps",children:[e.jsxs("div",{className:"step",children:[e.jsx("div",{className:"step-number",children:"1"}),e.jsxs("div",{className:"step-content",children:[e.jsx("h4",{children:"Share Your Link"}),e.jsx("p",{children:"Send your unique referral link to friends and family"})]})]}),e.jsxs("div",{className:"step",children:[e.jsx("div",{className:"step-number",children:"2"}),e.jsxs("div",{className:"step-content",children:[e.jsx("h4",{children:"They Sign Up"}),e.jsx("p",{children:"When someone clicks your link and creates an account"})]})]}),e.jsxs("div",{className:"step",children:[e.jsx("div",{className:"step-number",children:"3"}),e.jsxs("div",{className:"step-content",children:[e.jsx("h4",{children:"Earn Rewards"}),e.jsx("p",{children:"Get $10 for each successful referral"})]})]})]})]}),b.length>0&&e.jsxs("div",{className:"referral-history",children:[e.jsx("h3",{children:"ðŸ“‹ Referral History"}),e.jsx("div",{className:"history-list",children:b.map(a=>{const s=U(a.status),t=a.user_profiles,d=t?`${t.first_name||""} ${t.last_name||""}`.trim()||t.username:"Unknown User";return e.jsxs("div",{className:"history-item",children:[e.jsxs("div",{className:"history-user",children:[e.jsx("div",{className:"user-avatar",children:d.charAt(0).toUpperCase()}),e.jsxs("div",{className:"user-info",children:[e.jsx("div",{className:"user-name",children:d}),e.jsx("div",{className:"referral-date",children:new Date(a.created_at).toLocaleDateString()})]})]}),e.jsxs("div",{className:"history-status",children:[e.jsxs("span",{className:`status-badge ${s.class}`,children:[s.icon," ",s.text]}),a.reward_given&&e.jsxs("div",{className:"reward-amount",children:["+$",(a.reward_amount||0).toLocaleString()]})]})]},a.id)})})]}),b.length===0&&e.jsxs("div",{className:"empty-history",children:[e.jsx("div",{className:"empty-icon",children:"ðŸ‘¥"}),e.jsx("h3",{children:"No Referrals Yet"}),e.jsx("p",{children:"Start sharing your referral link to earn rewards!"})]})]})};export{H as default};
//# sourceMappingURL=ReferralProgram-DO0-huJz.js.map
